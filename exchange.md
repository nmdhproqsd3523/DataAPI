### 去中心化交易所链上设计

#### 挂单操作
##### 创建模板

###### 在BBC链上挂单示例信息如下 

|     属性 | 说明                                                 |
| -------: | :--------------------------------------------------- |
| 挂单地址 | 1xxxxx                                               |
|     币对 | BBC/MKF                                              |
|     价格 | 10                                                   |
|     费率 | 0.2%                                                 |
| 秘密hash | 0xxxxxxx                                             |
| 有效高度 | 到达这个高度之后，挂单返回                           |
| 撮合地址 | 挂三个地址（默认1000高度为一个处理单元）1xxxxx(0.1%) |
| 交易地址 | 挂三个地址（默认1000高度为一个处理单元）1xxxxx(0.1%) |

- 生成模板地址后，把要卖掉的BBC转账到这个模板地址下
- 通过25519对秘密加密，对加密的数据放到vchdata中
- 如果到达指定的高度后，还没有完成的撮合交易金额，挂单者可取回自己的金额

###### 在MKF链上挂单示例信息如下：  

|     属性 | 说明                                                 |
| -------: | :--------------------------------------------------- |
| 挂单地址 | 1xxxxx                                               |
|     币对 | BBC/MKF                                              |
|     价格 | 10                                                   |
|     费率 | 0.2%                                                 |
| 秘密hash | 0xxxxxxx                                             |
| 有效高度 | 到达这个高度之后，挂单返回                           |
| 撮合地址 | 挂三个地址（默认1000高度为一个处理单元）1xxxxx(0.1%) |
| 交易地址 | 挂三个地址（默认1000高度为一个处理单元）1xxxxx(0.1%) |
- 生成模板地址后，把要买掉的MKF转账到这个模板地址下
- 通过25519对秘密加密，对加密的数据放到vchdata中
- 如果到达指定的高度后，还没有完成的撮合交易金额，挂单者可取回自己的金额

##### 给模板转账

- BBC的买方在BBC链上给挂单模板地址转账(转账时要附带模板信息)
- MKF的买方在MKF链上给挂单模板地址转账(转账时要附带模板信息)
- 转账后没有撮合任何交易，挂单者在指定高度后把自己的资金撤回

#### 转账操作

##### 撮合完成

###### 撮合的模板地址如下MKF:

|          属性 | 说明                                              |
| ------------: | :------------------------------------------------ |
|    撮合者地址 | 1xxxxx(必须是挂单给出的地址才合法)                |
|          费率 | 0.1%                                              |
|      交易金额 | 100MKF                                            |
|      交易价格 | 10                                                |
|   BBC挂单地址 | 1xxxxx                                            |
|   MKF挂单地址 | 1xxxxx                                            |
|   BBC秘密hash | xxxxx                                             |
|   MKF秘密hash | xxxxx                                             |
| MKF链上的高度 | 在这个高度之前可以跨链，之后资金原路返回          |
|    交易者地址 | 三个地址，这三个地址必须和MKF挂单信息中的地址相同 |

###### 撮合的模板地址如下BBC:

|          属性 | 说明                                              |
| ------------: | :------------------------------------------------ |
|    撮合者地址 | 1xxxxx(必须是挂单给出的地址才合法)                |
|          费率 | 0.1%                                              |
|      交易金额 | 10BBC                                             |
|      交易价格 | 10                                                |
|   BBC挂单地址 | 1xxxxx                                            |
|   MKF挂单地址 | 1xxxxx                                            |
|   BBC秘密hash | xxxxx                                             |
|   MKF秘密hash | xxxxx                                             |
| BBC链上的高度 | 在这个高度之前可以跨链，之后资金原路返回          |
|    交易者地址 | 三个地址，这三个地址必须和BBC挂单信息中的地址相同 |

- 撮合方不能出现撮合矛盾的情况，秘密发布的信息出现矛盾

##### 跨连转账
- 必须是挂单模板到跨链模板
- 跨链模板中的地址必须是挂单模板中的地址
- 跨链模板中的高度必须小于等于挂单中的高度
- 跨链模板中的费率必须等于挂单的费率
- 转账要附带跨链模板信息
- 必须小于等于挂单高度
- 价格要满足挂单者的要求

#### 完成交易
##### 交换秘密
交易者交换秘密
- 锁定高度高的一方先把自己的秘密公布给锁定高度低的一方
##### 完成操作
|   交易结果 | 说明                                                      |
| ---------: | :-------------------------------------------------------- |
|   正常完成 | 交易者给撮合者转账0.1%，给挂单者转账99.8%，给自己转账0.1% |
| 非正常完成 | 指定的高度后挂单者把自己的资金撤回                        |

- 正常完成需要挂单者双方的秘密
- 非正常完成不需要挂单者的秘密
